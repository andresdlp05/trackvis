<!DOCTYPE html>
<html lang="en" data-theme="corporate">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title> Visualization </title>
   <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
   <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
   <link href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css" rel="stylesheet" type="text/css" />
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css">
   <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
   <script src="{{url_for('static', filename='reorder.min.js')}}"></script>
   <!-- Scripts de CDN se cargarán al final del body para garantizar que D3 esté disponible -->
   <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
   <link href='https://cdn.boxicons.com/3.0.6/fonts/basic/boxicons.min.css' rel='stylesheet'>
</head>

<body class="">
<div class="h-screen w-full bg-base-200/40">
<!-- Top BAR -->
<div class="h-[calc(3rem)] w-full bg-base-100 shadow-sm flex flex-row justify-between p-1">
   <a class="btn btn-ghost text-2xl pointer-events-none font-semibold text-primary h-full">
   <svg class="mx-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24"  
fill="currentColor" viewBox="0 0 24 24" >
<!--Boxicons v3.0.6 https://boxicons.com | License  https://docs.boxicons.com/free-->
<path d="M12 9a3 3 0 1 0 0 6 3 3 0 1 0 0-6"></path><path d="M12 19c7.63 0 9.93-6.62 9.95-6.68.07-.21.07-.43 0-.63-.02-.07-2.32-6.68-9.95-6.68s-9.93 6.61-9.95 6.67c-.07.21-.07.43 0 .63.02.07 2.32 6.68 9.95 6.68Zm0-12c5.35 0 7.42 3.85 7.93 5-.5 1.16-2.58 5-7.93 5s-7.42-3.84-7.93-5c.5-1.16 2.58-5 7.93-5"></path>
</svg>
UrbanGazeVis</a>
   <div class="tabs tabs-box h-full" data-theme="light">
      <label class="tab h-full">
      <input type="radio" name="tabs-nav" aria-label="By image" checked="checked" data-target="view1"/>
      <svg class="mx-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24"  
fill="currentColor" viewBox="0 0 24 24" >
<!--Boxicons v3.0.6 https://boxicons.com | License  https://docs.boxicons.com/free-->
<path d="M5 21h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2m0-2v-1.59l3-3 1.29 1.29c.39.39 1.02.39 1.41 0l5.29-5.29 3 3V19h-14ZM19 5v5.59L16.71 8.3a.996.996 0 0 0-1.41 0l-5.29 5.29-1.29-1.29a.996.996 0 0 0-1.41 0l-2.29 2.29V5h14Z"></path><path d="M8.5 7a1.5 1.5 0 1 0 0 3 1.5 1.5 0 1 0 0-3"></path>
</svg> By image
      </label>
      <label class="tab h-full">
      <input type="radio" name="tabs-nav" aria-label="By participant" data-target="view2"/>
     <svg  class="mx-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24"  
fill="currentColor" viewBox="0 0 24 24" >
<!--Boxicons v3.0.6 https://boxicons.com | License  https://docs.boxicons.com/free-->
<path d="m12,11c1.71,0,3-1.29,3-3s-1.29-3-3-3-3,1.29-3,3,1.29,3,3,3Zm0-4c.6,0,1,.4,1,1s-.4,1-1,1-1-.4-1-1,.4-1,1-1Z"></path><path d="m13,12h-2c-2.76,0-5,2.24-5,5v.5c0,.83.67,1.5,1.5,1.5h9c.83,0,1.5-.67,1.5-1.5v-.5c0-2.76-2.24-5-5-5Zm-5,5c0-1.65,1.35-3,3-3h2c1.65,0,3,1.35,3,3h-8Z"></path><path d="m6.5,11c.47,0,.9-.12,1.27-.33-.48-.77-.77-1.68-.77-2.67,0-.66.13-1.28.35-1.85-.26-.09-.55-.15-.85-.15-1.44,0-2.5,1.06-2.5,2.5s1.06,2.5,2.5,2.5Z"></path><path d="m6.11,12h-.61c-1.93,0-3.5,1.57-3.5,3.5v1c0,.28.22.5.5.5h1.5c0-1.96.81-3.73,2.11-5Z"></path><path d="m17.5,11c1.44,0,2.5-1.06,2.5-2.5s-1.06-2.5-2.5-2.5c-.31,0-.59.06-.85.15.22.57.35,1.19.35,1.85,0,.99-.29,1.9-.77,2.67.37.21.79.33,1.27.33Z"></path><path d="m18.5,12h-.61c1.3,1.27,2.11,3.04,2.11,5h1.5c.28,0,.5-.22.5-.5v-1c0-1.93-1.57-3.5-3.5-3.5Z"></path>
</svg>
      By participant
   </div>
</div>


<!-- CONTENT BAR -->
<div class='h-[calc(100vh-3rem)] w-full flex flex-row gap-2 p-2' id="view1">

   <div class="bg-base-100 flex flex-col w-[calc(10%)] shadow-md/30 rounded-xl">
   <div class="h-[calc(5%)] rounded-xl"><div class="btn btn-ghost btn-lg w-full h-full pointer-events-none font-bold text-md text-secondary">Controls</div></div>
   <div class="h-[calc(95%)] p-4" id="controls">
      <fieldset class="fieldset">
      <legend class="fieldset-legend">Image</legend>
      <select class="select select-xs" id="img-select">
         <option disabled selected>Select an image</option>
      </select>
      </fieldset>
      <fieldset class="fieldset">
      <legend class="fieldset-legend">Participant:</legend>
      <select class="select select-xs select-bordered w-full" id="part-select">
         <option disabled selected>Select a participant</option>
      </select>
      </fieldset>
      <fieldset class="fieldset">
      <legend class="fieldset-legend">Points:</legend>
      <select class="select select-xs select-bordered w-full" id="data-type-select">
         <option value="fixations">Fixations Points</option>
         <option value="gaze" selected>Gaze Points</option>
      </select>
      </fieldset>
      <fieldset class="fieldset">
      <legend class="fieldset-legend">Segmentation Class:</legend>
      <select class="select select-xs select-bordered w-full" id="data-set-select">
         <option value="main_class" selected>ADE20K Classes</option>
         <option value="grouped">ADE20K + Grouped Classes</option>
         <option value="disorder">ADE20K + Disorder Classes</option>
         <option value="grouped_disorder">ADE20K + Grouped + Disorder Classes</option>
      </select>
      </fieldset>
   </div>
   </div>

   <div class="flex flex-col w-[calc(90%)] h-full gap-2">
   <div class="flex flex-row w-full h-2/3 gap-2">
   
   <div class="bg-base-100 h-full w-[calc(42%)] shadow-md/30 rounded-xl">
   <div class="h-[calc(5%)] flex items-center rounded-xl">
      <div class="btn btn-ghost btn-lg flex-1 h-full pointer-events-none font-semibold text-secondary">Image View</div>
   </div>
      <div class="h-[calc(95%)] w-full flex flex-col gap-1 p-1">
      <div class="h-[calc(95%)] w-full flex items-center justify-center overflow-hidden relative" id="component-1">
         <img id="sel-img-view" class="h-full">
         <div id="overlay-points-container"></div>
      </div>
      <div class="h-[calc(5%)] flex flex-row justify-center gap-2" id="img-view-controls">
         <div class="btn btn-ghost btn-sm h-full pointer-events-none">Mode:</div>
         <button id="btn-original" class="btn btn-sm h-full btn-primary" onclick="switchImageView('original')">Original</button>
         <button id="btn-segmentation" class="btn btn-sm h-full btn-outline" onclick="switchImageView('segmentation')">Segmentation</button>
         <div class="btn btn-ghost btn-sm h-full pointer-events-none">Overlay:</div>
         <div class="flex flex-row gap-3 items-center h-full">
            <label class="flex items-center gap-1 cursor-pointer">
               <input type="checkbox" class="checkbox checkbox-xs overlay-checkbox" value="points" />
               <span class="text-xs">Points</span>
            </label>
            <label class="flex items-center gap-1 cursor-pointer">
               <input type="checkbox" class="checkbox checkbox-xs overlay-checkbox" value="contour" />
               <span class="text-xs">Contour</span>
            </label>
            <label class="flex items-center gap-1 cursor-pointer">
               <input type="checkbox" class="checkbox checkbox-xs overlay-checkbox" value="heatmap" />
               <span class="text-xs">Heatmap</span>
            </label>
         </div>
         <div id="clearBrushBtn" class="btn btn-soft btn-error h-full btn-disabled">Clear</div>
      </div>
      </div>
   </div>

   <div class="bg-base-100 h-full w-[calc(58%)] shadow-md/30 rounded-xl">
   <div class="h-[calc(5%)] rounded-xl"><div class="btn btn-ghost btn-lg w-full h-full pointer-events-none font-semibold text-secondary">Participant Attention Summary</div></div>
   <div class="h-[calc(95%)] w-full flex flex-row py-1">
      <div class="h-full w-[calc(90%)]" id="heatmap-plot"></div>
      <div class="h-full w-[calc(10%)] border-l-1 border-base-300 border-dashed px-1">
         <div class="h-[calc(10%)] w-full flex flex-col " id="heatmap-plot-controls">
            <div class="btn btn-xs btn-ghost pointer-events-none h-1/2">Mode:</div>
            <select class="select select-xs h-1/2" id="heatmap-mode-sel">
               <option selected>Attention Intensity</option>
               <option>Total attention</option>
            </select>
            <div> </div>
         </div>
         <div class="h-[calc(90%)] w-full" id="heatmap-plot-legend"></div>
      </div>
   </div>
   </div>

   </div>
   <div class="bg-base-100 h-1/3 w-full shadow-md/30 rounded-xl" id="component-2">
   <div class="h-[calc(10%)] w-full  rounded-xl"><div class="btn btn-ghost btn-lg w-full h-full pointer-events-none font-semibold text-secondary">Temporal Participant Attention</div></div>
   <div class="h-[calc(90%)] w-full flex flex-col py-1">
      <div class="h-[calc(90%)] w-full" id="scarf-plot"></div>
      <div class="h-[calc(10%)] w-full flex flex-row justify-center" id="scarf-plot-legend"></div>
   </div>
   </div>
   </div>

</div>

<!--VISTA POR PARTICIPANTEEE-->

<div class='h-[calc(100vh-3rem)] w-full flex flex-row gap-2 p-2 hidden' id="view2">

<div class="w-[calc(100%)] h-full gap-2 flex flex-col">
   <div class="w-full h-1/2 rounded-xl bg-base-100 shadow-md/30 flex flex-col">
      <div class="h-[calc(10%)] rounded-xl"><div class="btn btn-ghost btn-lg w-full h-full pointer-events-none font-semibold text-secondary">Participant Attention Summary</div></div>
      <div class="h-[calc(90%)] w-full flex flex-row p-1">
         <div class="h-full w-[calc(10%)] border-r-1 border-base-300 border-dashed px-2">
            <div class="btn btn-ghost btn-sm pointer-events-none">Participant</div>
            <select class="select select-xs" id="part-select-v2">
               <option disabled selected>Select a participant</option>
            </select>
            

            <div class="w-full flex flex-row my-1">
            <div class="btn btn-ghost btn-sm  pointer-events-none">Normalize</div>
            <div class="flex flex-col justify-center">
            <label class="toggle text-base-content">
            <input type="checkbox" id="heatmap-normalize"/>
            <svg aria-label="disabled" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"
            stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 6 6 18" />
            <path d="m6 6 12 12" />
            </svg>
            <svg aria-label="enabled" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <g stroke-linejoin="round" stroke-linecap="round" stroke-width="4" fill="none" stroke="currentColor">
            <path d="M20 6 9 17l-5-5"></path>
            </g>
            </svg>
            </label></div>
            </div>
            
         </div>
         <div class="h-full w-[calc(85%)]" id="attention-heatmap-plot"></div>
         <div class="h-full w-[calc(5%)]" id="attention-heatmap-plot-legend"></div>

      </div>
   </div>

   <div class="w-full h-1/2 max-h-1/2 flex flex-row gap-2">
      <div class="w-1/2 h-full rounded-xl bg-base-100 shadow-md/30 flex flex-col">
         <div class="h-[calc(10%)] rounded-xl"><div class="btn btn-ghost btn-lg w-full h-full pointer-events-none font-semibold text-secondary">Image projection</div></div>
         <div class="h-[calc(90%)] w-full flex flex-row">
            <div class="h-full w-[calc(65%)] flex flex-col px-2">
               <div class="w-full h-6/7 bg-base-300/30" id="attention-heatmap-bottom-left"></div>
               <div class="w-full h-1/7" id="image-projection-legend"></div>
            </div>
            <div class="h-full w-[calc(35%)] border-l-1 border-base-300 border-dashed py-1">
            <div class="w-full h-full overflow-y-scroll" id='controls2-selected-images'></div>
            </div>
         </div>

      </div>
      <div class="w-1/2 h-full rounded-xl bg-base-100 shadow-md/30">
         <div class="h-[calc(10%)] rounded-xl"><div class="btn btn-ghost btn-lg w-full h-full pointer-events-none font-semibold text-secondary">Saliency coverage comparison</div></div>
         <div class="h-[calc(90%)] w-full flex flex-row py-1">
            <div class="h-full w-[calc(85%)]" id="attention-heatmap-bottom"></div>
            <div class="h-full w-[calc(15%)] border-l-1 border-base-300 border-dashed px-2">
                  <div class="w-full h-1/3">
                  <div class="btn btn-ghost btn-xs pointer-events-none w-full">Y axis:</div>
                  <select class="select select-xs w-full" id="metric-select">
                  <option value="coverage" selected>Coverage</option>
                  <option value="entropy">Entropy</option>
                  </select>
                  <div class="btn btn-ghost btn-xs pointer-events-none w-full">X axis:</div>
                  <select class="select select-xs w-full" id="coverage-view-select">
                  <option value="by-score" selected>Score</option>
                  <option value="by-image">Img id</option>
                  <option value="by-time">Time</option>
                  </select>
                  </div>
                  <div class="w-full h-2/3" id="saliency-scatterplot-legend">
                  </div>
            </div>
         </div>
      </div>
   </div>
</div>

<!--VISTA POR IMAGEN-->
<div class='h-[calc(100vh-4rem)] w-full flex flex-row gap-1 p-1 hidden' id="view3">
   <div class="bg-base-100 flex flex-col w-[calc(15%)]"><div class="h-[calc(10%)] bg-primary-content"><div class="btn btn-ghost w-full h-full pointer-events-none font-bold text-lg text-secondary">Controls</div></div>
      <div class="h-[calc(90%)] p-4" id="controls3">
         <fieldset class="fieldset">
         <legend class="fieldset-legend">Image</legend>
         <select class="select select-sm" id="img-select-v3">
            <option disabled selected>Select an image</option>
         </select>
         </fieldset>
         <fieldset class="fieldset">
         <legend class="fieldset-legend">Participant</legend>
         <select class="select select-sm" id="part-select-v3">
            <option disabled selected>Select an image first</option>
         </select>
         </fieldset>
      </div>
   </div>
   <div class="w-[calc(85%)] h-full gap-1 bg-base-100">
      <div class="h-[calc(5%)] w-full flex flex-row justify-center" id="img-info-v3">
         <div class="btn btn-ghost pointer-events-none h-full w-1/5 text-secondary" id="sel-img-id-v3"></div>
         <div class="btn btn-ghost pointer-events-none h-full w-1/5 text-secondary" id="sel-part-id-v3"></div>
      </div>
      <div class="h-[calc(95%)] w-full flex flex-row justify-center p-1">
         <img id="sel-img-view-v3" class="h-full">
      </div>
   </div>
</div>

<div id="image-tooltip" class="w-1/4 h-1/3 hidden bg-neutral p-1 rounded-lg">
   <div id="image-tooltip-info" class="h-1/4 text-white text-center text-sm"></div>
   <div id="image-tooltip-img" class="bg-base-300 h-3/4"></div>
</div>
<!-- Scripts de CDN PRIMERO (en orden correcto) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/boxicons@2.1.3/dist/boxicons.js"></script>

<!-- Scripts locales DESPUÉS de que D3 y jQuery estén disponibles -->
<script type="text/javascript">
// One way to get data from server
const data = {{data|tojson}};
const allImages = {{all_images|tojson}};
const allParticipants = {{all_participants|tojson}};
const imgPartIndex = {{img_part_index|tojson}};

// Esperar a que D3 esté completamente disponible antes de ejecutar scripts que lo usan
function waitForD3Libraries() {
    if (typeof d3 === 'undefined' || typeof jQuery === 'undefined') {
        setTimeout(waitForD3Libraries, 50);
        return;
    }

    // D3 y jQuery están disponibles, cargar glyph_brush.js dinámicamente
    const glyphScript = document.createElement('script');
    glyphScript.src = "{{ url_for('static', filename='glyph_brush2.js') }}?v=" + new Date().getTime();
    glyphScript.onload = function() {
        // Cuando glyph_brush cargue, cargar main.js
        const mainScript = document.createElement('script');
        mainScript.src = "{{ url_for('static', filename='main2.js') }}?v=" + new Date().getTime();
        document.body.appendChild(mainScript);
    };
    document.body.appendChild(glyphScript);
}

// Iniciar cuando document esté listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', waitForD3Libraries);
} else {
    waitForD3Libraries();
}
</script>
</body>
</html>
